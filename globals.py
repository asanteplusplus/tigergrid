# Global Variables of the Hybrid System
import numpy as np
import simplejson as json
import sys

def init():
    global latitude
    global longitude
    global sys_data
    global pv_resource
    global pv_data
    global wind_data
    global loads
    global load_sigma
    global gen_data
    global batt_data
    global batt_char
    global address
    global duration
    global zone
    global zoneLoadDict
    global load_kwhd
    global enough_power
    global start_date 
    global end_date 
    global isSolar
    global isWind
    global isBattery
    global isGenerator
    global output
    global opt_solar
    global opt_wind
    global opt_batt
    global opt_gen
    global optimizer
    
    # Initializing the Variables
    latitude = 5.5600141 
    longitude = -0.2057437
    address = "Click Update Button"
    duration = 365
    load_kwhd = 20
    enough_power = True 
    optimizer = False
    isSolar = True
    isWind = False
    isBattery = True
    isGenerator = True
    output = "This is your output file"
    opt_solar = 25
    opt_wind = 25
    opt_batt = 25
    opt_gen = 25
    zone = "Af"
    start_date = "20150101"
    end_date = "20150131"
    sys_data = {
        'sys_config'    : 3,                  # System configuration (0=Gen, 1=PV-Gen, 2=PV-batt, 3=PV-batt-gen)
        'is_wind'       : False,
        'is_batt'       : False,
        'is_pv'         : False,
        'is_gen'        : True,
        'proj_title'    : 'Default project',
        'proj_desc'     : 'Default project'
    }

    zoneLoadDict = {'Af': {
                        '0': '1035.2', 
                        '1': '28448', 
                        '2': '7607.2', 
                        '3': '21807', 
                        '4': '2167.9', 
                        '5': '853.64', 
                        '6': '4151', 
                        '7': '3085.2', 
                        '8': '598.2', 
                        '9': '14311', 
                        '10': '1955.6', 
                        '11': '218.14', 
                        '12': '1147', 
                        '13': '992.99', 
                        '14': '5539.8', 
                        '15': '744.81'
                        },
                'Am': {
                        '0': '1076.8', 
                        '1': '28467', 
                        '2': '7820', 
                        '3': '22922', 
                        '4': '2221.9', 
                        '5': '908.91', 
                        '6': '4251.3', 
                        '7': '3248.4', 
                        '8': '615.96', 
                        '9': '15486', 
                        '10': '2028.2', 
                        '11': '231.45', 
                        '12': '1227.5', 
                        '13': '1045', 
                        '14': '5555.6', 
                        '15': '1218.2'
                        },
                'Aw': {
                        '0': '1129.1', 
                        '1': '28553', 
                        '2': '7894.5', 
                        '3': '23911', 
                        '4': '2323.3', 
                        '5': '976.91', 
                        '6': '4362.6', 
                        '7': '3452.2', 
                        '8': '641.07', 
                        '9': '16575', 
                        '10': '2117.9', 
                        '11': '243.64', 
                        '12': '1302', 
                        '13': '1103', 
                        '14': '5742.7', 
                        '15': '1288.6'
                        },
                'As': {
                        '0': '1021.1', 
                        '1': '28148', 
                        '2': '7795.6', 
                        '3': '22256', 
                        '4': '2140.5', 
                        '5': '847.61', 
                        '6': '4189.1', 
                        '7': '3108.6', 
                        '8': '591.27', 
                        '9': '14767', 
                        '10': '1948.3', 
                        '11': '221.09', 
                        '12': '1174.8', 
                        '13': '1004', 
                        '14': '5470.6', 
                        '15': '1178.8'
                        },
                'BWh': {
                        '0': '941.16', 
                        '1': '24909', 
                        '2': '6858.6', 
                        '3': '17831', 
                        '4': '2022.5', 
                        '5': '749.81', 
                        '6': '3964.3', 
                        '7': '2656', 
                        '8': '560.48', 
                        '9': '10086', 
                        '10': '1693.2', 
                        '11': '187.13', 
                        '12': '923.9', 
                        '13': '870.57', 
                        '14': '4813.3', 
                        '15': '697.13'
                        },
                'BWk': {
                        '0': '852.03', 
                        '1': '22263', 
                        '2': '6169.3', 
                        '3': '15151', 
                        '4': '2007.3', 
                        '5': '623.39', 
                        '6': '3782.4', 
                        '7': '2258.3', 
                        '8': '519.22', 
                        '9': '6801.9', 
                        '10': '1556.7', 
                        '11': '173.49', 
                        '12': '843.05', 
                        '13': '765.66', 
                        '14': '4473.8', 
                        '15': '773.87'
                        },
                'BSh': {
                        '0': '1030.5', 
                        '1': '28682', 
                        '2': '7459.9', 
                        '3': '21822', 
                        '4': '2203.5', 
                        '5': '847.72', 
                        '6': '4119.9', 
                        '7': '3061.8', 
                        '8': '598.84', 
                        '9': '13946', 
                        '10': '1929', 
                        '11': '219.33', 
                        '12': '1150.2', 
                        '13': '997.06', 
                        '14': '5466.3', 
                        '15': '766.74'
                        },
                'BSk': {
                        '0': '860.78', 
                        '1': '24473', 
                        '2': '6520.6', 
                        '3': '16335', 
                        '4': '2120.4', 
                        '5': '643.02', 
                        '6': '3799.9', 
                        '7': '2341.4', 
                        '8': '524.77', 
                        '9': '8143.1', 
                        '10': '1626.1', 
                        '11': '179.74', 
                        '12': '883.74', 
                        '13': '794.34', 
                        '14': '4515.8', 
                        '15': '758.8'
                        },
                'Csa': {
                        '0': '869.41', 
                        '1': '23172', 
                        '2': '6383.8', 
                        '3': '15554', 
                        '4': '1930.9', 
                        '5': '642.58', 
                        '6': '3771', 
                        '7': '2323.9', 
                        '8': '524.85', 
                        '9': '7439.5', 
                        '10': '1574', 
                        '11': '175.08', 
                        '12': '852.46', 
                        '13': '774.15', 
                        '14': '4365.7', 
                        '15': '742.88'
                        },
                'Csb': {
                        '0': '850.88', 
                        '1': '22321', 
                        '2': '6146.1', 
                        '3': '14846', 
                        '4': '1979.8', 
                        '5': '595.54', 
                        '6': '4066.9', 
                        '7': '2224.2', 
                        '8': '515.34', 
                        '9': '6577.2', 
                        '10': '1528.7', 
                        '11': '173.14', 
                        '12': '840.68', 
                        '13': '757.7', 
                        '14': '4223.8', 
                        '15': '752.84'
                        },
                'Csc': {
                        '0': '884.9', 
                        '1': '23214', 
                        '2': '6391.9', 
                        '3': '15440', 
                        '4': '2059.0', 
                        '5': '619.4', 
                        '6': '4229.6', 
                        '7': '2313.2', 
                        '8': '536.0', 
                        '9': '6840.3', 
                        '10': '1589.8', 
                        '11': '180.1', 
                        '12': '874.3', 
                        '13': '788.0', 
                        '14': '4392.8', 
                        '15': '783.0'
                        },
                'Cwa': {
                        '0': '912.9', 
                        '1': '24331', 
                        '2': '6703.0', 
                        '3': '16332', 
                        '4': '2027.4', 
                        '5': '674.7', 
                        '6': '3959.6', 
                        '7': '2440.1', 
                        '8': '551.1', 
                        '9': '7811.5', 
                        '10': '1652.7', 
                        '11': '183.8', 
                        '12': '895.1', 
                        '13': '812.9', 
                        '14': '4584.0', 
                        '15': '780.0'
                        },
                'Cwb': {
                        '0': '834.6', 
                        '1': '22245', 
                        '2': '6128.4', 
                        '3': '14932', 
                        '4': '1853.7', 
                        '5': '616.9', 
                        '6': '3620.2', 
                        '7': '2230.9', 
                        '8': '503.9', 
                        '9': '7141.9', 
                        '10': '1511.0', 
                        '11': '168.1', 
                        '12': '818.4', 
                        '13': '743.2', 
                        '14': '4191.1', 
                        '15': '713.2'
                        },
                'Cwc': {
                        '0': '825.4', 
                        '1': '21651', 
                        '2': '5961.7', 
                        '3': '14401', 
                        '4': '1920.4', 
                        '5': '577.7', 
                        '6': '3944.9', 
                        '7': '2157.5', 
                        '8': '499.9', 
                        '9': '6379.9', 
                        '10': '1482.8', 
                        '11': '167.9', 
                        '12': '815.5', 
                        '13': '735.0', 
                        '14': '4097.1', 
                        '15': '730.3'
                        },
                'Cfa': {
                        '0': '838.02', 
                        '1': '26210', 
                        '2': '6593', 
                        '3': '15911', 
                        '4': '1919.5', 
                        '5': '603.37', 
                        '6': '3503.3', 
                        '7': '2250.7', 
                        '8': '511.16', 
                        '9': '7439.8', 
                        '10': '1540.1', 
                        '11': '173.34', 
                        '12': '834.47', 
                        '13': '754.91', 
                        '14': '4504.1', 
                        '15': '718.53'
                        },
                'Cfb': {
                        '0': '851.3', 
                        '1': '25030', 
                        '2': '6582.1', 
                        '3': '16200', 
                        '4': '1982.6', 
                        '5': '618.01', 
                        '6': '3671.4', 
                        '7': '2302.9', 
                        '8': '518.79', 
                        '9': '7808.9', 
                        '10': '1578.9', 
                        '11': '176.3', 
                        '12': '866.4', 
                        '13': '779.27', 
                        '14': '4534.7', 
                        '15': '732.46'
                        },
                'Cfc': {
                        '0': '863.2', 
                        '1': '26996', 
                        '2': '6790.8', 
                        '3': '16388', 
                        '4': '1977.1', 
                        '5': '621.5', 
                        '6': '3608.4', 
                        '7': '2318.2', 
                        '8': '526.5', 
                        '9': '7663.0', 
                        '10': '1586.3', 
                        '11': '178.5', 
                        '12': '859.5', 
                        '13': '777.6', 
                        '14': '4639.2', 
                        '15': '740.1'
                        },
                'Dsa': {
                        '0': '874.6', 
                        '1': '23035', 
                        '2': '6261.1', 
                        '3': '15146', 
                        '4': '2028.7', 
                        '5': '634.4', 
                        '6': '3961.6', 
                        '7': '2303.1', 
                        '8': '531.8', 
                        '9': '6822.9', 
                        '10': '1568.6', 
                        '11': '177.6', 
                        '12': '868.5', 
                        '13': '786.5', 
                        '14': '4521.0', 
                        '15': '788.3'
                        },
                'Dsb': {
                        '0': '857.49', 
                        '1': '22583', 
                        '2': '6138.3', 
                        '3': '14849', 
                        '4': '1988.9', 
                        '5': '621.92', 
                        '6': '3883.9', 
                        '7': '2257.9', 
                        '8': '521.37', 
                        '9': '6689.1', 
                        '10': '1537.8', 
                        '11': '174.09', 
                        '12': '851.47', 
                        '13': '771.09', 
                        '14': '4432.4', 
                        '15': '772.84'
                        },
                'Dsc': {
                        '0': '802.67', 
                        '1': '21717', 
                        '2': '5959.4', 
                        '3': '13934', 
                        '4': '2043.9', 
                        '5': '575.43', 
                        '6': '3431.9', 
                        '7': '2120.7', 
                        '8': '495.82', 
                        '9': '5707.3', 
                        '10': '1489.5', 
                        '11': '164.18', 
                        '12': '819.39', 
                        '13': '745.57', 
                        '14': '4359.6', 
                        '15': '774.46'
                        },
                'Dsd': {
                        '0': '818.7', 
                        '1': '22151', 
                        '2': '6078.6', 
                        '3': '14213', 
                        '4': '2084.8', 
                        '5': '586.9', 
                        '6': '3500.5', 
                        '7': '2163.1', 
                        '8': '505.7', 
                        '9': '5821.4', 
                        '10': '1519.3', 
                        '11': '167.5', 
                        '12': '835.8', 
                        '13': '760.5', 
                        '14': '4446.8', 
                        '15': '789.9'
                        },
                'Dwa': {
                        '0': '867.78', 
                        '1': '24833', 
                        '2': '6634.7', 
                        '3': '16390', 
                        '4': '2045.9', 
                        '5': '639.33', 
                        '6': '3825.7', 
                        '7': '2356.4', 
                        '8': '526.84', 
                        '9': '8275.7', 
                        '10': '1610.4', 
                        '11': '180.49', 
                        '12': '892.49', 
                        '13': '800.43', 
                        '14': '4493.6', 
                        '15': '747.81'
                        },
                'Dwb': {
                        '0': '848.41', 
                        '1': '23646', 
                        '2': '6300.8', 
                        '3': '15747', 
                        '4': '2240.9', 
                        '5': '625.24', 
                        '6': '3860.7', 
                        '7': '2287.4', 
                        '8': '518.79', 
                        '9': '7500.6', 
                        '10': '1653.4', 
                        '11': '179.02', 
                        '12': '874.63', 
                        '13': '782.19', 
                        '14': '4409.8', 
                        '15': '765.18'
                        },
                'Dwc': {
                        '0': '841.7', 
                        '1': '24088', 
                        '2': '6435.7', 
                        '3': '15898', 
                        '4': '1984.5', 
                        '5': '620.2', 
                        '6': '3710.9', 
                        '7': '2285.7', 
                        '8': '511.0', 
                        '9': '8027.4', 
                        '10': '1562.1', 
                        '11': '175.1', 
                        '12': '865.7', 
                        '13': '776.4', 
                        '14': '4358.8', 
                        '15': '725.4'
                        },
                'Dwd': {
                        '0': '873.9', 
                        '1': '24355', 
                        '2': '6489.8', 
                        '3': '16219', 
                        '4': '2308.1', 
                        '5': '644.0', 
                        '6': '3976.5', 
                        '7': '2356.0', 
                        '8': '534.4', 
                        '9': '7725.6', 
                        '10': '1703.0', 
                        '11': '184.4', 
                        '12': '900.9', 
                        '13': '805.7', 
                        '14': '4542.1', 
                        '15': '788.1'
                        },
                'Dfa': {
                        '0': '846.36', 
                        '1': '25716', 
                        '2': '6617.4', 
                        '3': '16200', 
                        '4': '1996.8', 
                        '5': '618.53', 
                        '6': '3648.4', 
                        '7': '2293', 
                        '8': '517.44', 
                        '9': '7893.3', 
                        '10': '1569.4', 
                        '11': '175.69', 
                        '12': '855.67', 
                        '13': '772.8', 
                        '14': '4495.1', 
                        '15': '727.32'
                        },
                'Dfb': {
                        '0': '815.85', 
                        '1': '24879', 
                        '2': '6357.7', 
                        '3': '15055', 
                        '4': '2004.1', 
                        '5': '583.56', 
                        '6': '3620.5', 
                        '7': '2179.8', 
                        '8': '504.65', 
                        '9': '6504', 
                        '10': '1509.4', 
                        '11': '169.94', 
                        '12': '820.34', 
                        '13': '738.89', 
                        '14': '4306.4', 
                        '15': '753.81'
                        },
                'Dfc': {
                        '0': '829.11', 
                        '1': '22159', 
                        '2': '5614.1', 
                        '3': '13402', 
                        '4': '2375.8', 
                        '5': '579.86', 
                        '6': '4039.4', 
                        '7': '2147.5', 
                        '8': '506.36', 
                        '9': '5600.2', 
                        '10': '1573.6', 
                        '11': '176.32', 
                        '12': '854.17', 
                        '13': '756.75', 
                        '14': '4189.6', 
                        '15': '777.79'
                        },
                'Dfd': {
                        '0': '908.8', 
                        '1': '25330', 
                        '2': '6749.4', 
                        '3': '16868', 
                        '4': '2400.5', 
                        '5': '669.8', 
                        '6': '4135.6', 
                        '7': '2450.3', 
                        '8': '555.7', 
                        '9': '8034.6', 
                        '10': '1771.1', 
                        '11': '191.8', 
                        '12': '936.9', 
                        '13': '837.9', 
                        '14': '4723.8', 
                        '15': '819.7'
                        },
                'ET': {
                        '0': '843.3', 
                        '1': '22816', 
                        '2': '6260.9', 
                        '3': '14639', 
                        '4': '2147.3', 
                        '5': '604.5', 
                        '6': '3605.6', 
                        '7': '2228', 
                        '8': '520.9', 
                        '9': '5996.1', 
                        '10': '1564.9', 
                        '11': '172.5', 
                        '12': '860.9', 
                        '13': '783.3', 
                        '14': '4580.2', 
                        '15': '813.6'
                        },
                'EF': {
                        '0': '856.4', 
                        '1': '23868', 
                        '2': '6360.0', 
                        '3': '15895', 
                        '4': '2262.0', 
                        '5': '631.1', 
                        '6': '3897.0', 
                        '7': '2308.9', 
                        '8': '523.7', 
                        '9': '7571.1', 
                        '10': '1668.9', 
                        '11': '180.7', 
                        '12': '882.9', 
                        '13': '789.5', 
                        '14': '4451.3', 
                        '15': '772.4'
                        }
                }
    
    
    pv_data = {
        'area'    : 200,                # The Area spanned by the PV array in square metres
        'P_coeff'  : -0.35,             # Power temperature coefficient (% per deg C). How the power decreases with temperature
        'PV_eff'   : 0.30,              # The efficiency of the PV system
        'wire_eff'  : 0.95,             # The efficiency of the wiring of the system
        'eff_inv' : 0.95,               # Efficiency of PV inverter (AC coupled) or charge controller (DC coupled) in %
        'tilt'   : 10.0,                # Tilt angle
        'pvcap'  : 0.29,                # Capacity of the PV
        'pvbrand' : "SunRun",            # brand of the PV
        'inverter' : "Fronius" 
    }

    wind_data = {
        'P_eff'  : 0.50,                # Power efficiency of the wind turbine. Betz limit = 0.59
        'rated_wind_speed'   : 14.0,         # The efficiency of the Wind Turbine
        'blade_length'  : 17,           # The length of the wind turbine blades
        'area'          : 8495,         # Area of the wind turbine
        'hub_height'   : 50.0,          # Height of the Wind turbine hub
        'air_density'  : 1.23,          # The density of the air around the turbine
        'brand' : "Raum Energy",        # brand of the Wind turbine
        'cap' : 60                      # Capacity of the Wind turbine
    }

    
    batt_data = {
        'n_batt'     : 2,                                      # Number of batteries
        'C_nom'      : 1000,                                   # Nominal capacity (Ah)
        'v_dc'       : 12,                                    # Nominal system dc voltage (V)
        'SOC_min'    : 30,                                     # Minimum state of charge (battery "empty")
        'SOC_0'      : 100,                                    # Initial state of charge
        'SOC_cyc'    : 80,                                     # State of charge setpoint for cycle charging
        'eff_conv'   : 94.0,                                   # Battery converter / inverter   efficiency (%)
        'p_set'      : 80000,                                  # PV output setpoint for ramp control mode at AC load side (in W)
        'brand'      : "Trojan"                                # Battery brand
    }

    gen_data = {
        'n_gen'     : 1,                   # Number of parallel generators
        'P_gen'     : 60,                  # Generator capacity (kW)
        'l_min'     : 0.4,                # Minimum generator loading (%)
        'e_f'       : 0.27,                # Fuel efficiency (litres/kWh)
        'chg_eff'   : 95.0,                # Generator AC/DC charger efficiency in % (for DC coupled only)
        'c_f'       : 0.65,                 # Fuel cost (USD/kWh)   
        'brand'     : "Asante Generator"
    }

    
    global filename   
    filename = ""    
    

def write_project_to_file(fname, data = False, readable = True):
    global filename

        
    if not data:    
        data = dict()    
        
        data['latitude'] = latitude
        data['longitude'] = longitude
        data['sys_data'] = sys_data
        data['wind_data'] = wind_data
        data['pv_data'] = pv_data
        data['load_kwhd'] = load_kwhd
        data['duration'] = duration
        data['gen_data'] = gen_data
        data['batt_data'] = batt_data
        data['zone'] = zone
        
    try:
        fp = open(fname, mode = 'w')
        if readable:
            json.dump(data, fp, cls=NumpyJSONEncoder, indent = "  ", separators=(',', ': '), sort_keys = True)
        else:
            json.dump(data, fp, cls=NumpyJSONEncoder, indent = 2, separators=(',',':'))
        fp.close()
        filename = fname
    except:
        return False
    return True
    

def load_project_from_file(fname, populate = True):
    global latitude
    global longitude
    global sys_data
    global pv_resource
    global pv_data
    global loads
    global load_sigma
    global gen_data
    global batt_data
    global batt_char
    global filename
    
    try:
        fp = open(fname, mode = 'r')
        data = json.load(fp, object_hook = NumpyJSONDecoder)
        fp.close    
        filename = fname
        if populate:
            latitude = data['latitude']
            longitude = data['longitude']
            sys_data = data['sys_data']
            wind_data = data['wind_data']
            pv_data = data['pv_data']
            load_kwhd = data['load_kwhd']
            gen_data = data['gen_data']
            batt_data = data['batt_data']
            duration = data['duration']
            zone = data['zone']
            
    except:
        print(sys.exc_info()[0], sys.exc_info()[1])
        return False
    return data
    